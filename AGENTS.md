# AGENTS.md ‚Äî clawd

## Project Overview

Personal infrastructure-as-code repo for provisioning and managing [OpenClaw](https://openclaw.ai) gateway servers on Hetzner Cloud. One-command setup (`./setup.sh`) bootstraps everything: Terraform, encrypted credential management (pass + GPG + age), cloud-init hardening, and credential deployment.

- **IaC:** Terraform >= 1.5 (Hetzner Cloud provider)
- **Server:** Hetzner CPX32 (4 vCPU, 8 GB RAM), Ubuntu 24.04
- **Credential management:** `pass` (GPG-encrypted) + `age` backups, private GitHub repo
- **Linting:** Trunk (shellcheck, tflint, checkov, prettier, yamllint, markdownlint, trufflehog)
- **Security:** Custom Checkov policies in `checkov-policies/`
- **Repo:** `chapati23/clawd` (private)

## Architecture

```
setup.sh                    # One-command: provision + credentials + verify (idempotent)
destroy.sh                  # One-command: teardown with delete-protection handling
Makefile                    # Day-to-day ops: ssh, logs, status, restart, update, etc.

scripts/
‚îú‚îÄ‚îÄ lib.sh                  # Shared helpers: colors, logging, GPG/pass utils, tfvars helpers
‚îú‚îÄ‚îÄ credentials-init.sh     # One-time: bootstrap pass + GPG + age + GitHub repo (MacBook)
‚îú‚îÄ‚îÄ add-bot.sh              # Per-bot: GPG key + credential scope + deploy key (MacBook)
‚îú‚îÄ‚îÄ credentials-server-setup.sh  # Server-side: import keys, clone credential store
‚îú‚îÄ‚îÄ credentials-backup.sh   # Cron (daily 03:00): tarball + push + prune 90d
‚îú‚îÄ‚îÄ credentials-rotate.sh   # Day-2: GPG key rotation (master or per-bot)
‚îî‚îÄ‚îÄ gcp-setup.sh            # GCP read-only SA bootstrap for agents

terraform/
‚îú‚îÄ‚îÄ main.tf                 # Providers, SSH key gen, firewall, Hetzner server, outputs
‚îú‚îÄ‚îÄ variables.tf            # Input vars (hcloud_token, API keys, server config)
‚îú‚îÄ‚îÄ user-data.yml           # Cloud-init: user, packages, Node.js 22, gcloud, OpenClaw, hardening
‚îú‚îÄ‚îÄ terraform.tfvars        # Secrets (gitignored, auto-generated by setup.sh)
‚îî‚îÄ‚îÄ .gitignore

checkov-policies/           # Custom Checkov YAML policies for Hetzner resources
```

### How setup.sh works (12 phases)

1. Check prerequisites (Terraform, SSH)
2. Detect/bootstrap credential infrastructure (pass + GPG + age)
3. Detect/create bot credentials (per-bot GPG key)
4. Resolve tokens (pass ‚Üí env ‚Üí tfvars ‚Üí interactive prompt)
5. Generate/update `terraform.tfvars`
6. `terraform init`
7. `terraform apply` (creates server + firewall + SSH key)
8. Extract outputs (server IP)
9. Wait for cloud-init (~2-3 min: Node.js, OpenClaw, gcloud, hardening)
10. Deploy credentials to server (SCP keys ‚Üí import GPG ‚Üí clone pass store)
11. Verification (Node, npm, OpenClaw, fail2ban, swap, SSH hardening, credential access)
12. Register SSH host key

### Credential store layout

```
~/.password-store/
  shared/              # Master key + ALL bot keys (API keys shared across bots)
  bot-<name>/          # Master key + that bot's key ONLY (bot-specific creds)
  infrastructure/      # Master key ONLY (Hetzner token ‚Äî no bot access)
```

## Commands

```bash
# Setup & teardown (run from repo root)
./setup.sh                    # Full provision (idempotent)
./setup.sh --check            # Check-only mode (if it exists)
./destroy.sh                  # Teardown with confirmation
./destroy.sh --yes            # Teardown without confirmation

# Day-to-day (via Makefile)
make ssh                      # SSH into server
make logs                     # Tail OpenClaw gateway logs
make status                   # Show OpenClaw service status
make restart                  # Restart OpenClaw gateway
make stop                     # Emergency stop
make update                   # Update OpenClaw to latest + restart
make tunnel                   # SSH tunnel for remote gateway access (port 18789)

# Credential management
make add-bot NAME=mybot       # Create new bot credentials
make rotate-key TARGET=master # Rotate GPG key (master or bot name)
make cred-status              # Show credential store status on server

# Scripts (run from repo root)
./scripts/credentials-init.sh          # One-time credential bootstrap (MacBook)
./scripts/add-bot.sh <name> [yes|no]   # Add bot (optional shared access)
./scripts/gcp-setup.sh <project> <bot> # GCP read-only SA for an agent
./scripts/credentials-rotate.sh <target>  # Rotate GPG key

# Quality checks
trunk check --fix                      # Lint + format all
trunk check --fix <file>               # Single file
trunk check --all                      # Full project scan
cd terraform && terraform validate     # Terraform config validation
```

## Common Tasks

### Adding a new bot

```bash
# On MacBook:
make add-bot NAME=newbot
# Creates: GPG key, pass scope, deploy key, GitHub deploy key
# Then run setup.sh to provision/deploy credentials
```

### Adding a new API token to the store

```bash
# On MacBook:
pass insert shared/<service>/api-key          # Shared across bots
pass insert bot-<name>/<service>/api-key      # Bot-specific
cd ~/.password-store && git add -A && git commit -m "Add <service> key" && git push

# On server (or via make ssh):
cd ~/.password-store && git pull
```

### Adding a new cloud-init package or step

Edit `terraform/user-data.yml`. Changes only apply to **new** servers (cloud-init runs once). For existing servers, SSH in and apply manually, or reprovision.

### Adding a Terraform variable

1. Add to `terraform/variables.tf` (with type, default, description)
2. If it's a secret from pass, add the mapping to `TOKEN_MAP` in `setup.sh`
3. If it needs to be in tfvars, add to the generation block in `setup.sh`

## Code Style & Conventions

- **Shell scripts:** Bash, `set -euo pipefail`, shellcheck-clean
- **All scripts source `scripts/lib.sh`** for shared helpers (logging, GPG, pass, tfvars)
- **Terraform:** HCL fmt via trunk, tflint for best practices, custom Checkov policies
- **YAML:** Prettier + yamllint (no redundant quotes)
- **Security scanning:** trufflehog (secret detection), checkov (IaC security), osv-scanner (dependency vulns)
- **No direct linter invocation** ‚Äî always use `trunk check` / `trunk fmt`

### Shell script patterns

- Use `lib.sh` helpers: `step()`, `info()`, `ok()`, `warn()`, `error()` for logging
- Use `pass_get()`, `pass_entry_exists()`, `gpg_key_id()`, `gpg_key_exists()` ‚Äî don't reinvent
- Use `tfvars_get()` / `tfvars_update()` for safe terraform.tfvars manipulation
- Temporary sensitive files: use `mktemp` + `trap 'rm -f' EXIT`
- Scripts that run on server can't source `lib.sh` ‚Äî inline the logging helpers

### Terraform patterns

- All infrastructure changes go through Terraform (never manual `hcloud` CLI)
- Cloud-init for server bootstrapping (Node.js, OpenClaw, hardening)
- Secrets via `variable` with `sensitive = true`, resolved by setup.sh from pass
- Custom Checkov policies enforce: backups, delete/rebuild protection, labels, SSH keys, user data, firewall rules

## Post-Change Checks

| What Changed               | Check to Run                                                               |
| -------------------------- | -------------------------------------------------------------------------- |
| Terraform files (`.tf`)    | `trunk check --fix` + `cd terraform && terraform validate`                 |
| Shell scripts (`.sh`)      | `trunk check --fix` (runs shellcheck)                                      |
| YAML (cloud-init, configs) | `trunk check --fix` (prettier + yamllint)                                  |
| Checkov policies           | `trunk check --fix` + `trunk check --all --filter=checkov`                 |
| Trunk config               | `trunk check --all` (config affects all linters)                           |
| Multiple types             | `trunk check --fix` on changed files + `terraform validate` if .tf touched |

Always run `trunk check --all` at end of task.

## Troubleshooting

### "terraform validate" fails after provider/version changes

```bash
cd terraform && terraform init -backend=false  # Re-init providers
```

### setup.sh prompts for Hetzner token even though it's in pass

The pass path must be `infrastructure/hetzner/api-key`. Check with:

```bash
pass show infrastructure/hetzner/api-key
```

### SSH connection refused after provision

Cloud-init takes ~2-3 minutes. Wait for it, or check:

```bash
# From your Mac, if you have the IP:
ssh -i terraform/id_ed25519 molt@<IP> "sudo tail -50 /var/log/cloud-init-output.log"
```

### Checkov flags a new resource

Add required attributes (backups, labels, protection) or add a `checkov:skip` comment inside the resource block with justification.

### GPG key expired

```bash
gpg --edit-key <key-id>
> expire
> 2y
> save
cd ~/.password-store && git add -A && git commit -m "Extend key expiry" && git push
```

Or rotate fully: `./scripts/credentials-rotate.sh <master|bot-name>`

## Boundaries

- ‚úÖ **Do:** Add scripts, modify cloud-init, update Terraform resources, add Checkov policies, update credential management
- ‚úÖ **Do:** Use `lib.sh` helpers in new scripts
- ‚ö†Ô∏è **Ask first:** Changing firewall rules, modifying SSH hardening, adding new open ports, changing credential store layout
- üö´ **Never:** Store secrets in git, run raw `hcloud` CLI for infra changes, modify `terraform.tfvars` manually (use pass + setup.sh), disable security policies without justification
