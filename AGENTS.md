# AGENTS.md ‚Äî clawd

## Project Overview

Personal infrastructure-as-code repo for provisioning and managing [OpenClaw](https://openclaw.ai) gateway servers on Hetzner Cloud. One-command setup (`./setup.sh`) bootstraps everything: Terraform, encrypted credential management (pass + GPG + age), cloud-init hardening, and credential deployment.

- **IaC:** Terraform >= 1.5 (Hetzner Cloud provider)
- **Server:** Hetzner CPX32 (4 vCPU, 8 GB RAM), Ubuntu 24.04
- **Credential management:** `pass` (GPG-encrypted) + `age` backups, private GitHub repo
- **Networking:** Tailscale for private mesh access (dashboard, SSH over tailnet)
- **Linting:** Trunk (shellcheck, tflint, checkov, prettier, yamllint, markdownlint, trufflehog)
- **Security:** Custom Checkov policies in `checkov-policies/`
- **Repo:** `chapati23/clawd` (private)

## Architecture

```
setup.sh                    # One-command: provision + credentials + verify (idempotent)
destroy.sh                  # One-command: teardown with delete-protection handling
Makefile                    # Day-to-day ops: ssh, logs, status, restart, update, etc.

scripts/
‚îú‚îÄ‚îÄ lib.sh                  # Shared helpers: colors, logging, GPG/pass utils, tfvars helpers
‚îú‚îÄ‚îÄ credentials-init.sh     # One-time: bootstrap pass + GPG + age + GitHub repo (MacBook)
‚îú‚îÄ‚îÄ add-bot.sh              # Per-bot: GPG key + credential scope + deploy key (MacBook)
‚îú‚îÄ‚îÄ credentials-server-setup.sh  # Server-side: import keys, clone credential store
‚îú‚îÄ‚îÄ credentials-backup.sh   # Cron (daily 03:00): tarball + push + prune 90d
‚îú‚îÄ‚îÄ credentials-rotate.sh   # Day-2: GPG key rotation (master or per-bot)
‚îî‚îÄ‚îÄ gcp-setup.sh            # GCP read-only SA bootstrap for agents

terraform/
‚îú‚îÄ‚îÄ main.tf                 # Providers, SSH key gen, firewall (SSH + Syncthing), Hetzner server, Tailscale, outputs
‚îú‚îÄ‚îÄ variables.tf            # Input vars (hcloud_token, API keys, server config)
‚îú‚îÄ‚îÄ user-data.yml           # Cloud-init: user, packages, Node.js 22, gcloud, OpenClaw, Syncthing, Tailscale, hardening
‚îú‚îÄ‚îÄ terraform.tfvars        # Secrets (gitignored, auto-generated by setup.sh)
‚îî‚îÄ‚îÄ .gitignore

checkov-policies/           # Custom Checkov YAML policies for Hetzner resources
```

### How setup.sh works (12 phases)

1. Check prerequisites (Terraform, SSH)
2. Detect/bootstrap credential infrastructure (pass + GPG + age)
3. Detect/create bot credentials (per-bot GPG key)
4. Resolve tokens (pass ‚Üí env ‚Üí tfvars ‚Üí interactive prompt)
5. Generate/update `terraform.tfvars`
6. `terraform init`
7. `terraform apply` (creates server + firewall + SSH key)
8. Extract outputs (server IP)
9. Wait for cloud-init (~2-3 min: Node.js, OpenClaw, gcloud, hardening)
10. Deploy credentials to server (SCP keys ‚Üí import GPG ‚Üí clone pass store)
11. Verification (Node, npm, OpenClaw, fail2ban, swap, SSH hardening, credential access)
12. Register SSH host key

### Credential store layout

```
~/.password-store/
  shared/              # Master key + ALL bot keys (API keys shared across bots)
  bot-<name>/          # Master key + that bot's key ONLY (bot-specific creds)
  infrastructure/      # Master key ONLY (Hetzner token ‚Äî no bot access)
```

## Commands

```bash
# Setup & teardown (run from repo root)
./setup.sh                    # Full provision (idempotent)
./setup.sh --check            # Check-only mode (if it exists)
./destroy.sh                  # Teardown with confirmation
./destroy.sh --yes            # Teardown without confirmation

# Day-to-day (via Makefile)
make ssh                      # SSH into server
make logs                     # Tail OpenClaw gateway logs
make status                   # Show OpenClaw service status
make restart                  # Restart OpenClaw gateway
make stop                     # Emergency stop
make update                   # Update OpenClaw to latest + restart
make tunnel                   # SSH tunnel for remote gateway access (port 18789)
make dashboard                # Open OpenClaw dashboard in browser (via Tailscale)
make dashboard-setup          # One-time: configure gateway for Tailscale dashboard access
make dashboard-pair           # Approve pending browser device pairing request
make tailscale-ip             # Print the server's Tailscale IP
make tailscale-status         # Show Tailscale connection status

# Credential management
make add-bot NAME=mybot       # Create new bot credentials
make rotate-key TARGET=master # Rotate GPG key (master or bot name)
make cred-status              # Show credential store status on server

# Scripts (run from repo root)
./scripts/credentials-init.sh          # One-time credential bootstrap (MacBook)
./scripts/add-bot.sh <name> [yes|no]   # Add bot (optional shared access)
./scripts/gcp-setup.sh <project> <bot> # GCP read-only SA for an agent
./scripts/credentials-rotate.sh <target>  # Rotate GPG key

# Quality checks
trunk check --fix                      # Lint + format all
trunk check --fix <file>               # Single file
trunk check --all                      # Full project scan
cd terraform && terraform validate     # Terraform config validation
```

## Common Tasks

### Adding a new bot

```bash
# On MacBook:
make add-bot NAME=newbot
# Creates: GPG key, pass scope, deploy key, GitHub deploy key
# Then run setup.sh to provision/deploy credentials
```

### Adding a new API token to the store

```bash
# On MacBook:
pass insert shared/<service>/api-key          # Shared across bots
pass insert bot-<name>/<service>/api-key      # Bot-specific
cd ~/.password-store && git add -A && git commit -m "Add <service> key" && git push

# On server (or via make ssh):
cd ~/.password-store && git pull
```

### Accessing the OpenClaw dashboard

**With Tailscale (preferred):** HTTPS via Tailscale Serve, accessed at `https://<tailscale-hostname>/chat?session=main`.

```bash
make dashboard                # Opens the dashboard URL in your browser
make dashboard-setup          # One-time: configure gateway for Tailscale access
make dashboard-pair           # One-time: approve browser device pairing request
```

**First-time setup (after `openclaw onboard --install-daemon`):**

1. `make dashboard-setup` ‚Äî configures gateway: trustedProxies, allowedOrigins, allowTailscale, tailscale.mode
2. Open the dashboard in your browser (the URL is printed by the command above)
3. You'll see "pairing required" ‚Äî this is expected on first connect
4. `make dashboard-pair` ‚Äî approves your browser as a paired device
5. Reload the browser ‚Äî the dashboard should connect

**Mac-side DNS (one-time, CLI tailscale only):** The `brew install tailscale` CLI doesn't configure macOS DNS for `.ts.net` domains. Add the server's Tailscale IP to `/etc/hosts`:

```bash
# Get the Tailscale IP
make tailscale-ip

# Add to hosts (replace IP if different)
echo "100.91.85.88 giskard.tail847073.ts.net" | sudo tee -a /etc/hosts
```

This is needed because macOS's mDNSResponder can't reach Tailscale's DNS proxy (100.100.100.100) ‚Äî a [known limitation](https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOS) of the CLI-only version. The GUI app from [tailscale.com/download](https://tailscale.com/download) handles DNS automatically if you prefer.

**Without Tailscale (SSH tunnel fallback):**

```bash
make tunnel                   # Opens SSH tunnel forwarding port 18789
# Then browse to http://127.0.0.1:18789
```

### Setting up Tailscale on your Mac

Two installation options:

| Option                    | Install                                                  | DNS (`.ts.net`)       | Runs as                 |
| ------------------------- | -------------------------------------------------------- | --------------------- | ----------------------- |
| **GUI app** (recommended) | [tailscale.com/download](https://tailscale.com/download) | Automatic (MagicDNS)  | macOS network extension |
| **CLI-only**              | `brew install tailscale`                                 | Manual (`/etc/hosts`) | `tailscaled` daemon     |

The GUI app handles DNS automatically. The CLI version requires a manual `/etc/hosts` entry per server (see "Mac-side DNS" above).

**CLI setup:**

```bash
# Install
brew install tailscale

# Start the daemon (needs root for TUN device)
sudo tailscaled &

# Authenticate (opens browser for login)
tailscale up

# Verify
tailscale status
```

**GUI setup:** Install from [tailscale.com/download](https://tailscale.com/download), launch the app, and sign in from the menu bar icon. No terminal needed.

### Setting up Tailscale (server-side)

Tailscale is installed automatically during provisioning. To enable auto-join:

1. Generate a reusable auth key at <https://login.tailscale.com/admin/settings/keys> (reusable keys expire after 90 days)
2. Store it in pass: `pass insert infrastructure/tailscale/auth-key`
3. Run `./setup.sh` ‚Äî the key is resolved automatically and the server joins your tailnet on boot
4. After `openclaw onboard`, run `make dashboard-setup` to configure gateway for Tailscale access

If the auth key is omitted, Tailscale is still installed but not connected. SSH in and run `tailscale up` manually to authenticate.

### Gateway config for Tailscale dashboard

These settings are applied by `make dashboard-setup` and stored in `~/.openclaw/openclaw.json` on the server:

| Setting                            | Value                    | Purpose                                      |
| ---------------------------------- | ------------------------ | -------------------------------------------- |
| `gateway.trustedProxies`           | `["127.0.0.1"]`          | Trust tailscale serve as a reverse proxy     |
| `gateway.controlUi.allowedOrigins` | `["https://<hostname>"]` | Allow Control UI from Tailscale HTTPS origin |
| `gateway.auth.allowTailscale`      | `true`                   | Accept Tailscale identity headers for auth   |
| `gateway.tailscale.mode`           | `serve`                  | Auto-configure `tailscale serve` for HTTPS   |

Device pairing is a separate step from auth ‚Äî each new browser must be approved once via `make dashboard-pair` (or `openclaw devices approve <requestId>` on the server).

### Adding a new cloud-init package or step

Edit `terraform/user-data.yml`. Changes only apply to **new** servers (cloud-init runs once). For existing servers, SSH in and apply manually, or reprovision.

### Adding a Terraform variable

1. Add to `terraform/variables.tf` (with type, default, description)
2. If it's a secret from pass, add the mapping to `TOKEN_MAP` in `setup.sh`
3. If it needs to be in tfvars, add to the generation block in `setup.sh`

## Code Style & Conventions

- **Shell scripts:** Bash, `set -euo pipefail`, shellcheck-clean
- **All scripts source `scripts/lib.sh`** for shared helpers (logging, GPG, pass, tfvars)
- **Terraform:** HCL fmt via trunk, tflint for best practices, custom Checkov policies
- **YAML:** Prettier + yamllint (no redundant quotes)
- **Security scanning:** trufflehog (secret detection), checkov (IaC security), osv-scanner (dependency vulns)
- **No direct linter invocation** ‚Äî always use `trunk check` / `trunk fmt`

### Shell script patterns

- Use `lib.sh` helpers: `step()`, `info()`, `ok()`, `warn()`, `error()` for logging
- Use `pass_get()`, `pass_entry_exists()`, `gpg_key_id()`, `gpg_key_exists()` ‚Äî don't reinvent
- Use `tfvars_get()` / `tfvars_update()` for safe terraform.tfvars manipulation
- Temporary sensitive files: use `mktemp` + `trap 'rm -f' EXIT`
- Scripts that run on server can't source `lib.sh` ‚Äî inline the logging helpers

### Terraform patterns

- All infrastructure changes go through Terraform (never manual `hcloud` CLI)
- Cloud-init for server bootstrapping (Node.js, OpenClaw, hardening)
- Secrets via `variable` with `sensitive = true`, resolved by setup.sh from pass
- Custom Checkov policies enforce: backups, delete/rebuild protection, labels, SSH keys, user data, firewall rules

## Post-Change Checks

| What Changed               | Check to Run                                                               |
| -------------------------- | -------------------------------------------------------------------------- |
| Terraform files (`.tf`)    | `trunk check --fix` + `cd terraform && terraform validate`                 |
| Shell scripts (`.sh`)      | `trunk check --fix` (runs shellcheck)                                      |
| YAML (cloud-init, configs) | `trunk check --fix` (prettier + yamllint)                                  |
| Checkov policies           | `trunk check --fix` + `trunk check --all --filter=checkov`                 |
| Trunk config               | `trunk check --all` (config affects all linters)                           |
| Multiple types             | `trunk check --fix` on changed files + `terraform validate` if .tf touched |

Always run `trunk check --all` at end of task.

## Troubleshooting

### "terraform validate" fails after provider/version changes

```bash
cd terraform && terraform init -backend=false  # Re-init providers
```

### setup.sh prompts for Hetzner token even though it's in pass

The pass path must be `infrastructure/hetzner/api-key`. Check with:

```bash
pass show infrastructure/hetzner/api-key
```

### SSH connection refused after provision

Cloud-init takes ~2-3 minutes. Wait for it, or check:

```bash
# From your Mac, if you have the IP:
ssh -i terraform/id_ed25519 molt@<IP> "sudo tail -50 /var/log/cloud-init-output.log"
```

### Checkov flags a new resource

Add required attributes (backups, labels, protection) or add a `checkov:skip` comment inside the resource block with justification.

### GPG key expired

```bash
gpg --edit-key <key-id>
> expire
> 2y
> save
cd ~/.password-store && git add -A && git commit -m "Extend key expiry" && git push
```

Or rotate fully: `./scripts/credentials-rotate.sh <master|bot-name>`

## Boundaries

- ‚úÖ **Do:** Add scripts, modify cloud-init, update Terraform resources, add Checkov policies, update credential management
- ‚úÖ **Do:** Use `lib.sh` helpers in new scripts
- ‚ö†Ô∏è **Ask first:** Changing firewall rules, modifying SSH hardening, adding new open ports, changing credential store layout
- üö´ **Never:** Store secrets in git, run raw `hcloud` CLI for infra changes, modify `terraform.tfvars` manually (use pass + setup.sh), disable security policies without justification
