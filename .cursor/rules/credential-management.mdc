# Credential Management

When creating, storing, or accessing credentials (API keys, tokens, passwords, etc.), follow these rules.

## How Credentials Are Stored

This project uses `pass` (GPG-encrypted password store) backed by a private GitHub repo. Never store secrets in plaintext files, environment variables, code, or comments.

## Storing a New Credential

When you create or receive a new credential (API key, token, OAuth secret, etc.):

1. **Determine the correct path** based on scope:

| Scope | Path pattern | Who can decrypt |
| --- | --- | --- |
| Shared across all bots | `shared/<service>/<key-name>` | Master key + all bot keys |
| Specific to one bot | `bot-<bot-name>/<service>/<key-name>` | Master key + that bot's key |
| Infrastructure only | `infrastructure/<service>/<key-name>` | Master key only |

2. **Store it with `pass insert`**:

```bash
# Interactive (prompts for value):
pass insert shared/github/personal-access-token

# Non-interactive (pipe the value):
echo "ghp_xxxxxxxxxxxx" | pass insert -f shared/github/personal-access-token
```

3. **Always push after storing** to back up the encrypted credential:

```bash
cd ~/.password-store && git add -A && git commit -m "Add <service> credential" && git push
```

4. **Sync to the server** if the bot needs the credential at runtime:

```bash
# From your MacBook, SSH into the server and pull:
ssh -i terraform/id_ed25519 molt@$(terraform -chdir=terraform output -raw server_ip) "cd ~/.password-store && git pull"
```

Or use the Makefile shortcut to check status:

```bash
make cred-status
```

## Reading a Credential

```bash
# Print decrypted value:
pass show shared/anthropic/api-key

# Use in a script or command:
API_KEY=$(pass show shared/anthropic/api-key)
```

## Updating an Existing Credential

```bash
# -f overwrites without confirmation:
pass insert -f shared/anthropic/api-key

# Then push + sync:
cd ~/.password-store && git add -A && git commit -m "Rotate anthropic key" && git push
```

## Naming Conventions

- Use lowercase, hyphenated names: `api-key`, `bot-token`, `client-secret`
- Group by service: `shared/github/personal-access-token`, `shared/github/oauth-client-secret`
- Use descriptive names: `api-key` not `key`, `bot-token` not `token`

## Examples

```bash
# GitHub personal access token (shared)
echo "ghp_abc123" | pass insert -f shared/github/personal-access-token

# Telegram bot token (shared across bots)
echo "123456:ABC-DEF" | pass insert -f shared/telegram/bot-token

# Notion integration key (shared)
echo "ntn_xxx" | pass insert -f shared/notion/api-key

# Bot-specific credential
echo "xoxb-xxx" | pass insert -f bot-moltbot-01/slack/bot-token

# Infrastructure (no bot access)
echo "hc_xxx" | pass insert -f infrastructure/hetzner/api-key
```

## What NOT to Do

- **Never** store credentials in code, comments, `.env` files, or `terraform.tfvars` directly
- **Never** print/log decrypted credential values in chat or output
- **Never** skip the `git push` step after storing â€” the push IS the backup
- **Never** store credentials under the wrong scope (e.g., infrastructure tokens in `shared/`)
